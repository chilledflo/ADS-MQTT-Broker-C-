name: Build ADS Realtime C++

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup CMake
      uses: lukka/get-cmake@latest

    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2

    - name: Setup vcpkg
      shell: powershell
      run: |
        if (Test-Path C:\vcpkg) { Remove-Item -Recurse -Force C:\vcpkg }
        git clone https://github.com/Microsoft/vcpkg.git C:\vcpkg
        cd C:\vcpkg
        .\bootstrap-vcpkg.bat

    - name: Install dependencies
      shell: powershell
      run: |
        cd ${{ github.workspace }}
        C:\vcpkg\vcpkg.exe install --triplet x64-windows

    - name: Configure CMake
      run: |
        cmake -B build -G "Visual Studio 17 2022" -A x64 `
          -DCMAKE_TOOLCHAIN_FILE="C:/vcpkg/scripts/buildsystems/vcpkg.cmake" `
          -DCMAKE_BUILD_TYPE=Release `
          -DTWINCAT_ADS_ROOT="${{ github.workspace }}/lib"

    - name: Build
      run: |
        cmake --build build --config Release -j

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ads-realtime-bridge-windows
        path: |
          build/Release/*.exe
          build/Release/*.dll
        retention-days: 30

    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          build/Release/ads-realtime-bridge.exe
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup CMake
      uses: lukka/get-cmake@latest

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          g++ \
          cmake \
          git \
          pkg-config \
          libssl-dev

    - name: Setup vcpkg
      run: |
        git clone https://github.com/Microsoft/vcpkg.git ~/vcpkg
        ~/vcpkg/bootstrap-vcpkg.sh

    - name: Install Beckhoff ADS Library
      run: |
        cd /tmp
        git clone https://github.com/Beckhoff/ADS.git
        cd ADS/AdsLib
        # Patch CMakeLists.txt to add required cmake_minimum_required and find Threads
        sed -i '1i cmake_minimum_required(VERSION 3.10)' CMakeLists.txt
        sed -i '2i project(AdsLib)' CMakeLists.txt
        sed -i '3i find_package(Threads REQUIRED)' CMakeLists.txt
        # Fix missing CONFIG_DEFAULT_LOGLEVEL definition
        sed -i 's/CONFIG_DEFAULT_LOGLEVEL/3/g' Log.cpp
        mkdir build && cd build
        cmake ..
        make -j$(nproc)
        sudo make install
        sudo ldconfig

    - name: Install Paho MQTT
      run: |
        cd ${{ github.workspace }}
        ~/vcpkg/vcpkg install --triplet x64-linux

    - name: Configure CMake
      run: |
        rm -rf build
        ls -la
        echo "=== Checking CMakeLists.txt ==="
        head -n 5 CMakeLists.txt
        cmake -B build \
          -DCMAKE_TOOLCHAIN_FILE=~/vcpkg/scripts/buildsystems/vcpkg.cmake \
          -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: |
        cmake --build build -j$(nproc)

    - name: Run Tests (if available)
      run: |
        if [ -f build/tests ]; then
          ./build/tests
        fi

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ads-realtime-bridge-linux
        path: |
          build/ads-realtime-bridge
          build/examples/*
        retention-days: 30

    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          build/ads-realtime-bridge
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
